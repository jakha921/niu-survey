<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ survey.title }} - NIU Survey Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .niu-header {
            background: linear-gradient(135deg, #008000 0%, #00a000 100%);
        }
        .btn-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-close:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
        }
        .main-content {
            margin-top: 70px;
            height: calc(100vh - 70px);
        }
        .google-form-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6b7280;
            font-size: 1.1rem;
            flex-direction: column;
            gap: 1rem;
        }
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #008000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem;
            }
            .survey-title {
                font-size: 1rem;
            }
            .btn-close {
                padding: 0.25rem 0.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 overflow-hidden">
    <!-- Header -->
    <header class="niu-header shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Survey Title -->
                <div class="flex items-center space-x-4">
                    <a href="{% url 'surveys:survey_list' %}" class="w-8 h-8 bg-white rounded-md flex items-center justify-center hover:bg-gray-50 transition-colors">
                        <span class="text-green-600 font-bold text-sm">NIU</span>
                    </a>
                    <div>
                        <h1 class="text-white font-semibold text-lg survey-title">{{ survey.title }}</h1>
                        <p class="text-green-100 text-sm hidden sm:block">Navoi Innovation University Survey</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-3">
                    {% if not survey.is_login_req %}
                    <a href="{{ survey.google_form_url }}" target="_blank" 
                       class="hidden sm:inline-flex items-center px-3 py-2 text-sm font-medium text-green-600 bg-white rounded-md hover:bg-gray-50 transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Open in Google
                    </a>
                    {% endif %}
                    <button onclick="closeSurvey()" class="btn-close">
                        <span class="hidden sm:inline">Close</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>
                <p class="font-medium">Loading NIU Survey</p>
                <p class="text-sm text-gray-500">Please wait while we prepare your form...</p>
            </div>
        </div>
        
        <!-- Error State -->
        <div class="error-message bg-white" id="errorMessage">
            <div class="max-w-md mx-auto">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.502 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Unable to load survey</h3>
                <p class="text-gray-600 mb-6">The survey form could not be loaded. This might be due to network issues or form restrictions.</p>
                <div class="space-y-3">
                    <a href="{{ survey.google_form_url }}" target="_blank" 
                       class="inline-flex items-center justify-center w-full px-4 py-3 text-base font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Open in Google Forms
                    </a>
                    <button onclick="location.reload()" 
                            class="inline-flex items-center justify-center w-full px-4 py-3 text-base font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh Page
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Survey Form -->
        <iframe 
            src="{{ embed_url }}"
            class="google-form-iframe"
            id="googleForm"
            title="{{ survey.title }}"
            onload="handleIframeLoad()"
            onerror="handleIframeError()">
        </iframe>
    </main>

    <script>
        // Close survey function
        function closeSurvey() {
            // Try multiple methods to close/return
            if (window.opener) {
                // If opened in popup, close it
                window.close();
            } else if (window.history.length > 1) {
                // If there's history, go back
                window.history.back();
            } else {
                // Fallback: redirect to survey list
                window.location.href = '{% url "surveys:survey_list" %}';
            }
        }
        
        // Loading and error handling
        function handleIframeLoad() {
            document.getElementById('loading').style.display = 'none';
            console.log('NIU Survey form loaded successfully');
        }
        
        function handleIframeError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'flex';
            document.getElementById('googleForm').style.display = 'none';
            console.error('Error loading NIU Survey form');
        }
        
        // Hide loading after timeout as fallback
        setTimeout(function() {
            const loading = document.getElementById('loading');
            if (loading.style.display !== 'none') {
                handleIframeLoad();
            }
        }, 10000);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC key to close
            if (e.key === 'Escape') {
                closeSurvey();
            }
            // F11 for fullscreen toggle
            if (e.key === 'F11') {
                e.preventDefault();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
        });
        
        // Track form submission completion
        window.addEventListener('message', function(event) {
            // Listen for Google Forms submission completion
            if (event.data && event.data.type === 'hsFormCallback') {
                console.log('Survey submitted successfully');
                // Could show a success message or redirect
            }
        });
        
        // Prevent accidental navigation away
        let formStarted = false;
        
        document.getElementById('googleForm').addEventListener('load', function() {
            setTimeout(() => {
                formStarted = true;
            }, 5000); // Consider form started after 5 seconds
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (formStarted) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your survey progress may be lost.';
                return e.returnValue;
            }
        });
        
        // Add touch support for mobile devices
        document.addEventListener('DOMContentLoaded', function() {
            // Add swipe gesture for closing on mobile
            let startX = 0;
            let startY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', function(e) {
                if (!startX || !startY) return;
                
                let endX = e.changedTouches[0].clientX;
                let endY = e.changedTouches[0].clientY;
                
                let diffX = startX - endX;
                let diffY = startY - endY;
                
                // Swipe right to close (if swipe is significant)
                if (diffX > 100 && Math.abs(diffY) < 50) {
                    closeSurvey();
                }
                
                startX = 0;
                startY = 0;
            });
        });
    </script>
</body>
</html> 